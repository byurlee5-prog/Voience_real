<!DOCTYPE html>
<html>
<head>
  <title>보컬 트레이닝 녹음</title>
</head>
<body>
  <h1>보컬 트레이닝</h1>
  <button id="recordBtn">녹음 시작</button>
  <button id="stopBtn">녹음 종료</button>
  <input type="file" id="fileInput" accept="audio/*">
  <button id="uploadBtn">업로드</button>

  <!-- 녹음/업로드한 소리를 재생할 오디오 플레이어 -->
  <audio id="audioPlayer" controls></audio>

  <script>
    let mediaRecorder;
    let audioChunks = [];

    document.getElementById("recordBtn").onclick = async () => {
      audioChunks = []; // 새 녹음 시작할 때 초기화
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.start();
    };

    document.getElementById("stopBtn").onclick = () => {
      mediaRecorder.stop();
      mediaRecorder.onstop = () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
        const audioUrl = URL.createObjectURL(audioBlob);

        // 오디오 플레이어에 녹음된 소리 연결
        const audioPlayer = document.getElementById("audioPlayer");
        audioPlayer.src = audioUrl;
        audioPlayer.play();

        // 서버로 업로드
        const formData = new FormData();
        formData.append("file", audioBlob, "recording.wav");
        fetch("/upload", { method: "POST", body: formData });
      };
    };

    document.getElementById("uploadBtn").onclick = () => {
      const file = document.getElementById("fileInput").files[0];
      const formData = new FormData();
      formData.append("file", file);

      // 업로드한 파일도 재생
      const audioUrl = URL.createObjectURL(file);
      const audioPlayer = document.getElementById("audioPlayer");
      audioPlayer.src = audioUrl;
      audioPlayer.play();

      // 서버로 업로드
      fetch("/upload", { method: "POST", body: formData });
    };
  </script>
</body>
</html>
